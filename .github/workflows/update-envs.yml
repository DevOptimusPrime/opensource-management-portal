name: Generate an env-orgs.json file and upload to Azure

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
     - uses: actions/checkout@v2
     
     - name: echo
       run: |
         ls -lah
         
     - name: get orgs from graphql
       run: |
         gh api graphql -f ent=ASampleEnterprise -f query='query($ent: String!) {
          enterprise(slug: $ent) {
            organizations(first: 100) {
              nodes {
                description
                databaseId
                id
                name
              }
            }
          }
         }' >> raw.json
         cat raw.json
         
       env:
         GITHUB_TOKEN: ${{ secrets.ENT_READ_PAT}}
         GH_TOKEN: ${{ secrets.ENT_READ_PAT }}
         
     - name: run powershell script to create env orgs json
       run: |
         ./.github/scripts/Create-EnvOrgs.ps1
         cat orgs.json
         ls 
       shell: pwsh
       
     - name: check file
       run: |
         cat orgs.json
         ls -lah
         rm env-orgs.json
         cat orgs.json >> env-orgs.json
         cat env-orgs.json

     - name: Azure CLI Action
       uses: Azure/cli@v1
       with:
        # Specify the script here
        inlineScript: az storage file upload -s env-orgs --source env-orgs.json --connection-string $CONN 
       env:
         CONN: ${{secrets.AZURE_STORAGE_CONN }}
         
     
     - name: Azure Login
       uses: Azure/login@v1.4.6
       with:
         creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'
         
     - name: Azure CLI Action
       uses: Azure/cli@v1
       with:
        # Specify the script here
        inlineScript: az webapp restart --name os-portal --resource-group rg-nih-portal-prototype

      
