name: Generate and env-orgs.json file and upload to Azure

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
     - uses: actions/checkout@v2
     
     - name: echo
       run: |
         ls -lah
         
     - name: get orgs from graphql
       run: |
         gh api graphql -f ent=ASampleEnterprise -f query='query($ent: String!) {
          enterprise(slug: $ent) {
            organizations(first: 100) {
              nodes {
                description
                databaseId
                id
                name
              }
            }
          }
         }' >> raw.json
         cat raw.json
         
       env:
         GITHUB_TOKEN: ${{ secrets.ENT_READ_PAT}}
         GH_TOKEN: ${{ secrets.ENT_READ_PAT }}
         
     - name: run powershell script to create env orgs json
       run: |
         ./.github/scripts/Create-EnvOrgs.ps1
         cat orgs.json
         ls 
       shell: pwsh
       
     - name: check file
       run: |
         cat orgs.json
         ls -lah
         rm env-orgs.json
         cat orgs.json >> env-orgs.json
         cat env-orgs.json
         
     - name: upload to Azure files
       # You may pin to the exact commit or the version.
  # uses: rnakamine/azure-files-upload@5c1081adbe0d65b9c0a8be234f0e17ae93c8b741
       uses: rnakamine/azure-files-upload@v1.0.0
       with:
        # The connection string for the storage account.
        connection_string: ${{ secrets.AZURE_STORAGE_CONN }}
        # The directory to upload files from.
        source: ./env-orgs.json
        # The destination of the upload operation.
        destination: env-orgs

     
      
