name: Generate and env-orgs.json file and upload to Azure

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
     - uses: actions/checkout@v2
     
     - name: echo
       run: |
         ls -lah
         
     - name: get orgs from graphql
       run: |
         gh api graphql -f ent=ASampleEnterprise -f query='query($ent: String!) {
          enterprise(slug: $ent) {
            organizations(first: 100) {
              nodes {
                description
                databaseId
                id
                name
              }
            }
          }
         }' >> raw.json
         cat raw.json
         
       env:
         GITHUB_TOKEN: ${{ secrets.ENT_READ_PAT}}
         GH_TOKEN: ${{ secrets.ENT_READ_PAT }}
         
     - name: run powershell script to create env orgs json
       run: |
         ./.github/scripts/Create-EnvOrgs.ps1
         cat orgs.json
         ls 
       shell: pwsh
      
